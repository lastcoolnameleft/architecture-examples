# =============================================================================
# Kustomization File for Cluster-Wide RBAC
# =============================================================================
# Use this with kustomize to deploy cluster-wide RBAC resources
# 
# Usage:
#   kubectl apply -k rbac/cluster/
# =============================================================================

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: aks-iam-cluster-rbac
  annotations:
    description: "Cluster-wide RBAC roles and bindings for AKS IAM posture"

resources:
  - cluster-roles.yaml
  - cluster-rolebindings.yaml

labels:
  - pairs:
      app.kubernetes.io/part-of: aks-iam-posture
      app.kubernetes.io/managed-by: kustomize
    includeSelectors: false

# Load group IDs from group-ids.env in this directory (gitignored, generated by setup-demo-accounts.sh)
configMapGenerator:
  - name: group-ids
    envs:
      - group-ids.env
    options:
      disableNameSuffixHash: true

# Substitute group IDs into ClusterRoleBinding subjects
replacements:
  - source:
      kind: ConfigMap
      name: group-ids
      fieldPath: data.CLUSTER_VIEWER_GROUP_ID
    targets:
      - select:
          kind: ClusterRoleBinding
          name: cluster-readonly-binding
        fieldPaths:
          - subjects.[name=CLUSTER_VIEWER_GROUP_ID].name

  - source:
      kind: ConfigMap
      name: group-ids
      fieldPath: data.INFRA_OPS_L2_GROUP_ID
    targets:
      - select:
          kind: ClusterRoleBinding
          name: system-namespace-operator-binding
        fieldPaths:
          - subjects.[name=INFRA_OPS_L2_GROUP_ID].name
      - select:
          kind: ClusterRoleBinding
          name: cluster-admin-elevated-binding
        fieldPaths:
          - subjects.[name=INFRA_OPS_L2_GROUP_ID].name

  - source:
      kind: ConfigMap
      name: group-ids
      fieldPath: data.PLATFORM_SRE_L3_GROUP_ID
    targets:
      - select:
          kind: ClusterRoleBinding
          name: system-namespace-operator-binding
        fieldPaths:
          - subjects.[name=PLATFORM_SRE_L3_GROUP_ID].name
      - select:
          kind: ClusterRoleBinding
          name: cluster-admin-elevated-binding
        fieldPaths:
          - subjects.[name=PLATFORM_SRE_L3_GROUP_ID].name
