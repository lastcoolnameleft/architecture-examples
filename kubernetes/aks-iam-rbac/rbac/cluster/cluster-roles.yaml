# =============================================================================
# Cluster-Wide RBAC Roles and Bindings
# =============================================================================
# These RBAC resources define cluster-scoped permissions.
# Apply these to every AKS cluster during bootstrap.
#
# IMPORTANT: 
# - Replace <GROUP_OBJECT_ID> placeholders with actual Entra ID group object IDs
# - These roles use Azure RBAC for Kubernetes authorization
# - Groups should be managed via Entra ID PIM for JIT access
# =============================================================================
---

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cluster-dba
  labels:
    app.kubernetes.io/part-of: aks-iam-posture
    app.kubernetes.io/component: rbac
    iam.partner.com/role-type: cluster
    iam.partner.com/privilege-level: readonly
  annotations:
    description: "Cluster-wide read-only access for monitoring and troubleshooting"
    iam.partner.com/jit-required: "false"
rules:
  # Core resources - read only
  - apiGroups: [""]
    resources:
      - pods
    verbs: ["exec", "get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods/portforward"]
    verbs: ["get", "list", "create"]  
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: cluster-dba-binding
subjects:
- kind: Group
  name: <GROUP_OBJECT_ID> # Entra ID Group for DBAs
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: cluster-dba
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: app-namespace-command-centre-operator
rules:
- apiGroups: [""]
  resources:
    - pods
    - services
    - deployments
    - logs
  verbs: ["get", "list", "watch"]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata: 
  name: app-namespace-command-centre-operator-binding
subjects:
- kind: Group 
  name: <GROUP_OBJECT_ID> # Entra ID Group for Command Centre L1
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: app-namespace-command-centre-operator
  apiGroup: rbac.authorization.k8s.io

---
# =============================================================================
# CLUSTER ROLE: cluster-readonly
# =============================================================================
# Purpose: Read-only access to all cluster resources (cluster-wide view)
# Personas: All authenticated users as baseline, elevated roles for debugging
# Scope: Cluster-wide
# =============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cluster-readonly
  labels:
    app.kubernetes.io/part-of: aks-iam-posture
    app.kubernetes.io/component: rbac
    iam.partner.com/role-type: cluster
    iam.partner.com/privilege-level: readonly
  annotations:
    description: "Cluster-wide read-only access for monitoring and troubleshooting"
    iam.partner.com/jit-required: "false"
rules:
  # Core resources - read only
  - apiGroups: [""]
    resources:
      - namespaces
      - nodes
      - persistentvolumes
      - componentstatuses
    verbs: ["get", "list", "watch"]
  
  # View events cluster-wide
  - apiGroups: [""]
    resources:
      - events
    verbs: ["get", "list", "watch"]
  
  # Storage classes and CSI
  - apiGroups: ["storage.k8s.io"]
    resources:
      - storageclasses
      - csinodes
      - csidrivers
    verbs: ["get", "list", "watch"]
  
  # Networking - cluster-wide
  - apiGroups: ["networking.k8s.io"]
    resources:
      - ingressclasses
    verbs: ["get", "list", "watch"]
  
  # RBAC - view only (for auditing)
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources:
      - clusterroles
      - clusterrolebindings
    verbs: ["get", "list", "watch"]
  
  # API resources discovery
  - apiGroups: [""]
    resources:
      - componentstatuses
    verbs: ["get", "list", "watch"]
  
  # Metrics (for monitoring)
  - apiGroups: ["metrics.k8s.io"]
    resources:
      - nodes
      - pods
    verbs: ["get", "list", "watch"]
  
  # Custom Resource Definitions - view only
  - apiGroups: ["apiextensions.k8s.io"]
    resources:
      - customresourcedefinitions
    verbs: ["get", "list", "watch"]

---
# =============================================================================
# CLUSTER ROLE: system-namespace-operator
# =============================================================================
# Purpose: Full access to kube-system and other system namespaces
# Personas: Infra Operations Engineer (L2), Platform Engineer/SRE (L3)
# Scope: Cluster-wide (but mainly used in system namespaces)
# JIT Required: Yes - via Entra ID PIM
# =============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: system-namespace-operator
  labels:
    app.kubernetes.io/part-of: aks-iam-posture
    app.kubernetes.io/component: rbac
    iam.partner.com/role-type: cluster
    iam.partner.com/privilege-level: elevated
  annotations:
    description: "Full access to system namespaces (kube-system, kube-node-lease, etc.)"
    iam.partner.com/jit-required: "true"
    iam.partner.com/personas: "infra-ops-l2,platform-sre-l3"
rules:
  # Full access to all core resources in system namespaces
  - apiGroups: [""]
    resources:
      - pods
      - pods/log
      - pods/exec
      - pods/portforward
      - services
      - endpoints
      - configmaps
      - secrets
      - serviceaccounts
      - persistentvolumeclaims
      - events
      - resourcequotas
      - limitranges
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  
  # Workloads - full access
  - apiGroups: ["apps"]
    resources:
      - deployments
      - daemonsets
      - statefulsets
      - replicasets
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  
  # Batch resources
  - apiGroups: ["batch"]
    resources:
      - jobs
      - cronjobs
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  
  # Autoscaling
  - apiGroups: ["autoscaling"]
    resources:
      - horizontalpodautoscalers
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  
  # Policy
  - apiGroups: ["policy"]
    resources:
      - poddisruptionbudgets
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  
  # Networking
  - apiGroups: ["networking.k8s.io"]
    resources:
      - networkpolicies
      - ingresses
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  
  # RBAC management within namespaces
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources:
      - roles
      - rolebindings
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

---
# =============================================================================
# CLUSTER ROLE: cluster-admin-elevated
# =============================================================================
# Purpose: Full cluster administration capabilities
# Personas: Infra Operations Engineer (L2), Platform Engineer/SRE (L3)
# Scope: Cluster-wide
# JIT Required: Yes - via Entra ID PIM
# NOTE: This extends the built-in cluster-admin role with specific labeling
# =============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cluster-admin-elevated
  labels:
    app.kubernetes.io/part-of: aks-iam-posture
    app.kubernetes.io/component: rbac
    iam.partner.com/role-type: cluster
    iam.partner.com/privilege-level: admin
  annotations:
    description: "Full cluster administration - requires PIM elevation"
    iam.partner.com/jit-required: "true"
    iam.partner.com/personas: "infra-ops-l2,platform-sre-l3"
aggregationRule:
  clusterRoleSelectors:
    - matchLabels:
        rbac.authorization.k8s.io/aggregate-to-admin: "true"
rules: []  # Rules are aggregated from other ClusterRoles

---
# =============================================================================
# CLUSTER ROLE BINDING: cluster-readonly-binding
# =============================================================================
# Binds cluster-readonly role to baseline read access group
# This provides a safety net for all authenticated users to view cluster state
# =============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cluster-readonly-binding
  labels:
    app.kubernetes.io/part-of: aks-iam-posture
    app.kubernetes.io/component: rbac
  annotations:
    description: "Binds cluster readonly access to baseline view group"
subjects:
  # Entra ID Group: AKS-iam-sandbox-aks-ClusterViewer
  - kind: Group
    name: "7e4b9f98-8052-44dd-9473-f895ff3a3fc1"
    apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: cluster-readonly
  apiGroup: rbac.authorization.k8s.io

---
# =============================================================================
# CLUSTER ROLE BINDING: system-namespace-operator-binding
# =============================================================================
# Binds system-namespace-operator role to elevated ops groups
# JIT activation required via Entra ID PIM
# =============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: system-namespace-operator-binding
  labels:
    app.kubernetes.io/part-of: aks-iam-posture
    app.kubernetes.io/component: rbac
  annotations:
    description: "Binds system namespace operator access to infra/platform teams"
    iam.partner.com/jit-required: "true"
subjects:
  # Entra ID Group: AKS-iam-sandbox-aks-InfraOps-L2-Elevated
  - kind: Group
    name: "0a09b16f-a524-4214-ab1b-cdceaa89c41a"
    apiGroup: rbac.authorization.k8s.io
  # Entra ID Group: AKS-iam-sandbox-aks-PlatformSRE-L3-Elevated
  - kind: Group
    name: "7adb8e6d-1308-4cb1-a4dc-afed4be3a2c6"
    apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system-namespace-operator
  apiGroup: rbac.authorization.k8s.io

---
# =============================================================================
# CLUSTER ROLE BINDING: cluster-admin-elevated-binding
# =============================================================================
# Binds cluster-admin-elevated role to L2/L3 elevated groups
# JIT activation required via Entra ID PIM
# =============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cluster-admin-elevated-binding
  labels:
    app.kubernetes.io/part-of: aks-iam-posture
    app.kubernetes.io/component: rbac
  annotations:
    description: "Binds cluster admin access to elevated infra/platform teams"
    iam.partner.com/jit-required: "true"
subjects:
  # Entra ID Group: AKS-iam-sandbox-aks-InfraOps-L2-Elevated
  - kind: Group
    name: "0a09b16f-a524-4214-ab1b-cdceaa89c41a"
    apiGroup: rbac.authorization.k8s.io
  # Entra ID Group: AKS-iam-sandbox-aks-PlatformSRE-L3-Elevated
  - kind: Group
    name: "7adb8e6d-1308-4cb1-a4dc-afed4be3a2c6"
    apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io
