# =============================================================================
# Kustomization File for Namespace-Scoped RBAC
# =============================================================================
# Use this with kustomize to deploy namespace-scoped RBAC resources
# 
# Usage:
#   kubectl apply -k rbac/namespace/ -n <target-namespace>
#
# For multiple namespaces, create overlays or use a script to apply
# to each application namespace.
# =============================================================================

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: aks-iam-namespace-rbac
  annotations:
    description: "Namespace-scoped RBAC roles and bindings for AKS IAM posture"

resources:
  - namespace-roles.yaml
  - namespace-rolebindings.yaml

labels:
  - pairs:
      app.kubernetes.io/part-of: aks-iam-posture
      app.kubernetes.io/managed-by: kustomize
    includeSelectors: false

# Load group IDs from group-ids.env in this directory (gitignored, generated by setup-demo-accounts.sh)
configMapGenerator:
  - name: group-ids
    envs:
      - group-ids.env
    options:
      disableNameSuffixHash: true

# Substitute group IDs into RoleBinding subjects
replacements:
  - source:
      kind: ConfigMap
      name: group-ids
      fieldPath: data.APP_SUPPORT_L2_GROUP_ID
    targets:
      - select:
          kind: RoleBinding
          name: app-namespace-operator-binding
        fieldPaths:
          - subjects.[name=APP_SUPPORT_L2_GROUP_ID].name

  - source:
      kind: ConfigMap
      name: group-ids
      fieldPath: data.COMMAND_CENTRE_L1_GROUP_ID
    targets:
      - select:
          kind: RoleBinding
          name: l1-restricted-operator-binding
        fieldPaths:
          - subjects.[name=COMMAND_CENTRE_L1_GROUP_ID].name

  - source:
      kind: ConfigMap
      name: group-ids
      fieldPath: data.CLOUD_DEPLOYMENT_GROUP_ID
    targets:
      - select:
          kind: RoleBinding
          name: project-deployment-temp-binding
        fieldPaths:
          - subjects.[name=CLOUD_DEPLOYMENT_GROUP_ID].name

  - source:
      kind: ConfigMap
      name: group-ids
      fieldPath: data.CLUSTER_VIEWER_GROUP_ID
    targets:
      - select:
          kind: RoleBinding
          name: namespace-readonly-binding
        fieldPaths:
          - subjects.[name=CLUSTER_VIEWER_GROUP_ID].name
